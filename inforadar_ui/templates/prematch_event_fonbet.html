<!-- inforadar_ui/templates/prematch_event_fonbet.html -->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fonbet • Event {{ event_id }}</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 18px; }
    .muted { color:#777; }
    .err { color:#b00020; white-space: pre-wrap; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius: 999px; font-size:12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; }
    h3 { margin-top: 18px; }
    a { color:#0b57d0; text-decoration:none; }
    a:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <a href="/fonbet">← Назад</a>

  <h2>Fonbet • Event <span class="pill">{{ event_id }}</span></h2>

  <div class="muted" id="subtitle">Loading…</div>
  <div class="err" id="error"></div>

  <div id="content"></div>

<script>
  const EVENT_ID = Number("{{ event_id }}");
  const subtitle = document.getElementById('subtitle');
  const errorEl = document.getElementById('error');
  const content = document.getElementById('content');

  function esc(s) {
    return String(s ?? '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
    }[m]));
  }

  function setError(msg) { errorEl.textContent = msg || ''; }

  function renderOddsTable(title, rows) {
    if (!rows || !rows.length) {
      return `<div class="muted">Нет данных: ${esc(title)}</div>`;
    }
    const head = `<tr><th>Market</th><th>Outcome</th><th>Line</th><th>Odd</th><th>TS</th></tr>`;
    const body = rows.map(r => `
      <tr>
        <td>${esc(r.market)}</td>
        <td>${esc(r.outcome)}</td>
        <td>${esc(r.line)}</td>
        <td>${esc(r.odd)}</td>
        <td>${esc(r.ts)}</td>
      </tr>
    `).join('');
    return `<h3>${esc(title)} (${rows.length})</h3><table>${head}${body}</table>`;
  }

  async function loadEvent() {
    setError('');
    subtitle.textContent = 'Loading…';

    const r = await fetch(`/api/fonbet/event/${encodeURIComponent(EVENT_ID)}?limit=1500`);
    const data = await r.json().catch(() => ({}));

    if (!r.ok) {
      setError(`HTTP ${r.status}\n` + JSON.stringify(data, null, 2));
      subtitle.textContent = 'Ошибка';
      return;
    }

    if (data.error && String(data.error).trim()) {
      setError(String(data.error));
    }

    const e = data.event || {};
    subtitle.textContent = `${esc(e.start_time)} • ${esc(e.league_name || '-') } • ${esc(e.team1)} — ${esc(e.team2)} • sport_id=${esc(e.sport_id)}`;

    const m = data.markets || {};
    content.innerHTML = `
      ${renderOddsTable('Outcomes', m.outcomes || [])}
      ${renderOddsTable('Total', m.total || [])}
      ${renderOddsTable('Handicap', m.handicap || [])}
      ${renderOddsTable('Other', m.other || [])}
    `;
  }

  loadEvent().catch(e => {
    setError(String(e));
    subtitle.textContent = 'Ошибка';
  });
</script>
</body>
</html>
